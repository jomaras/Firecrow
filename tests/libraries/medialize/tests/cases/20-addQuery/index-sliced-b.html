<!DOCTYPE html>
<html>
<head>
<script>
(function (undefined)
{
    var URI = function (url, base)
    {
        if(!(this instanceof URI))
        {
            return new URI(url);
        }
        this.href(url);
        return this;
    }, p = URI.prototype;
    function isArray (obj)
    {
        return obj != null && obj instanceof Array;
    }
    URI.encode = encodeURIComponent;
    URI.decode = decodeURIComponent;
    URI.encodeQuery = function (string)
    {
        return URI.encode(string).replace(/%20/g, '+');
    };
    URI.decodeQuery = function (string)
    {
        return URI.decode((string + '').replace(/\+/g, '%20'));
    };
    var _parts, _part, generateAccessor;
    URI.parse = function (string)
    {
        var pos, parts = {};
        pos = string.indexOf('?');
        if(pos > -1)
        {
            parts.query = string.substring(pos + 1);
        }
        return parts;
    };
    URI.parseQuery = function (string)
    {
        if(!string)
        {
            return {};
        }
        string = string.replace(/&+/g, '&').replace(/^\?*&*|&+$/g, '');
        var items = {}, splits = string.split('&'), length = splits.length;
        for(var i = 0;i < length;i++)
        {
            var v = splits[i].split('='), name = URI.decodeQuery(v.shift()), value = v.length ? URI.decodeQuery(v.join('=')) : 0;
            if(items[name])
            {
                if(typeof (items[name]) === 'string')
                {
                    items[name] = [items[name]];
                }
                items[name].push(value);
            }
            else
            {
                items[name] = value;
            }
        }
        return items;
    };
    URI.buildQuery = function (data, duplicates)
    {
        var t = '';
        for(var key in data)
        {
            if(key)
            {
                if(isArray(data[key]))
                {
                    var unique = {};
                    for(var i = 0, length = data[key].length;i < length;i++)
                    {
                        if(data[key][i] !== undefined && unique[data[key][i] + ''] === undefined)
                        {
                            t += '&' + URI.buildQueryParameter(key, data[key][i]);
                        }
                    }
                }
                else if(data[key] !== undefined)
                {
                    t += '&' + URI.buildQueryParameter(key, data[key]);
                }
            }
        }
        return t.substring(1);
    };
    URI.buildQueryParameter = function (name, value)
    {
        return URI.encodeQuery(name) + (value !== null ? '=' + URI.encodeQuery(value) : '');
    };
    URI.addQuery = function (data, name, value)
    {
        if(typeof name === 'object')
        {
            for(var key in name)
            {
                URI.addQuery(data, key, name[key]);
            }
        }
        else if(typeof name === 'string')
        {
            if(data[name] === undefined)
            {
                data[name] = value;
                return ;
            }
            else if(typeof (data[name]) === 'string')
            {
                data[name] = [data[name]];
            }
            if(!(isArray(value)))
            {
                value = [value];
            }
            data[name] = data[name].concat(value);
        }
    };
    _parts = {query: '?', fragment: '#'};
    generateAccessor = function (_part, _key)
    {
        return function (v, build)
        {
            if(v === undefined)
            {
                return this._parts[_part];
            }
            else
            {
                if(v !== null)
                {
                    v = v + '';
                    if(v[0] === _key)
                    {
                        v = v.substring(1);
                    }
                }
                this._parts[_part] = v;
            }
        };
    };
    for(_part in _parts)
    {
        p[_part] = generateAccessor(_part, _parts[_part]);
    }
    p.href = function (href, build)
    {
        if(href === undefined);
        else
        {
            if(typeof href === 'string')
            {
                this._parts = URI.parse(href);
            }
        }
    };
    var q = p.query;
    p.query = function (v, build)
    {
        if(v === true)
        {
            return URI.parseQuery(this._parts.query);
        }
        else if(v !== undefined && typeof v !== 'string');
        else
        {
            return q.call(this, v, build);
        }
    };
    p.addQuery = function (name, value, build)
    {
        var data = URI.parseQuery(this._parts.query);
        URI.addQuery(data, name, value);
        this._parts.query = URI.buildQuery(data);
    };
    typeof module !== 'undefined' ? 0 : window.URI = URI;
})();
</script>
</head>
<body>
<script>
    var u = URI('?foo=bar');
    u.addQuery('baz', 'bam');
    var a1 = u.query() == 'foo=bar&baz=bam';
    u.addQuery('array', ['one', 'two']);
    var a2 = u.query() == 'foo=bar&baz=bam&array=one&array=two';
    u.query('?foo=bar');
    u.addQuery({'obj': 'bam', foo: 'baz'});
    var a3 = u.query() == 'foo=bar&foo=baz&obj=bam';
    u.addQuery({
        'foo': 'bam',
        bar: ['1', '2']
    });
    var a4 = u.query() == 'foo=bar&foo=baz&foo=bam&obj=bam&bar=1&bar=2';
    u.query('?foo=bar');
    u.addQuery({'bam': null, 'baz': ''});
    var a5 = u.query() == 'foo=bar&bam&baz=';
    u.query('');
    u.addQuery('some value', 'must be encoded because of = and ? and #');
    var a6 = u.query() == 'some+value=must+be+encoded+because+of+%3D+and+%3F+and+%23';
    var a7 = u.query(true)['some value'] == 'must be encoded because of = and ? and #';
    a1;
    a2;
    a3;
    a4;
    a5;
    a6;
    a7;
</script>
</body>
</html>