<!DOCTYPE html>
<html>
<head>
    <title>Firecrow - Debugging Doppel Browser</title>
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="htmlModelMapping.js"></script>
    <script src="htmlModelMapping1.js"></script>
    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/JsValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/CSSStyleDeclaration.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/webFile.js"></script>
    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>


    <script type="text/javascript" src="graphLibrary/js/jquery-1.4.2.min.js"></script>
    <!--  The Raphael JavaScript library for vector graphics display  -->
    <script type="text/javascript" src="graphLibrary/js/raphael.js"></script>
    <!--  Dracula  -->
    <!--  An extension of Raphael for connecting shapes -->
    <script type="text/javascript" src="graphLibrary/js/dracula_graffle.js"></script>
    <!--  Graphs  -->
    <script type="text/javascript" src="graphLibrary/js/dracula_graph.js"></script>
    <script type="text/javascript" src="graphLibrary/js/dracula_algorithms.js"></script>
</head>
<body>
    <h1>Firecrow - Debugging Doppel Browser</h1>
    <div id="canvas" style='height: 500; width: 1300'></div>
    <div id="messageContainer"></div>

    <script>
        var Firecrow = FBL.Firecrow;
        var WebFile = Firecrow.DoppelBrowser.WebFile;
        var Browser = Firecrow.DoppelBrowser.Browser;
        var webFile = new WebFile("file:///C:/GitWebStorm/Firecrow/debug/testFiles/54/index.html");

        var messageContainer = document.getElementById("messageContainer");

        var dependencyGraph = new Firecrow.DependencyGraph.DependencyGraph();
        var browser = new Browser(webFile, []);

        browser.registerNodeCreatedCallback(dependencyGraph.handleNodeCreated, dependencyGraph);
        browser.registerNodeInsertedCallback(dependencyGraph.handleNodeInserted, dependencyGraph);
        browser.registerInterpreterMessageGeneratedCallback(function(message)
        {
            messageContainer.innerHTML += "<br/>" + message;
        });

        browser.asyncBuildPage(function(){
            var model = HtmlModelMapping.getWholeFileModel(webFile.url);
            var globalObjectProperties = browser.globalObject.properties;
            var errors = "";
            model.results.forEach(function(result)
            {
                for(var propName in result)
                {
                    var hasBeenFound = false;
                    for(var i = 0; i < globalObjectProperties.length; i++)
                    {
                        var property = globalObjectProperties[i];
                        var propertyValue = property.value;

                        if(property.name == propName)
                        {
                            hasBeenFound = true;

                            if(propertyValue == null)
                            {
                                errors += propName + " is null, and should be: " + result[propName] + "\n";
                                break;
                            }

                            if(propertyValue.value != result[propName])
                            {
                                errors += propName + " does not match: " + result[propName] + " != " + propertyValue.value + "\n";
                            }

                            break;
                        }
                    }

                    if(!hasBeenFound)
                    {
                        errors += propName + " could not be found in global object!\n";
                    }
                }
            });

            if(errors != "") { alert("Errors on validating result:\n" + errors); }
            else { alert("Test OK!"); }
        });

        /*var redraw;

        window.onload = function() {
        var width = 1300;//$('#canvas').width();
        var height = 500;//$('#canvas').height() - 100;

        var renderHtml = function(r, n)
        {
        var textLength = n.id.length*7;
        var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
        frame.attr({'fill': '#0747CF','stroke-width' : '1px'});
        return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
        };

        var renderCss = function(r, n) {
        var textLength = n.id.length*7;
        var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
        frame.attr({'fill': '#CF0707','stroke-width' : '1px'});
        return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
        };

        var renderJs = function(r, n)
        {
        var textLength = n.id.length*7;
        var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
        frame.attr({'fill': '#06E606','stroke-width' : '1px'});
        return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
        };

        var g = new Graph();

        g.edgeFactory.build = function(source, target) {
        var e = jQuery.extend(true, {}, this.template);
        e.source = source;
        e.target = target;
        //e.style.label = "w";
        return e;
        }


        dependencyGraph.nodes.forEach(function(node)
        {
        var nodeId = node.generateId();

        var render = null;

        if(node.isHtmlNode()) { render = renderHtml; }
        else if(node.isCssNode()) { render = renderCss; }
        else if(node.isJsNode()) { render = renderJs;}

        g.addNode(nodeId, { render : render, label: nodeId });
        });

        dependencyGraph.nodes.forEach(function(node)
        {
        node.structuralDependencies.forEach(function(edge)
        {
        g.addEdge(edge.sourceNode.generateId(), edge.destinationNode.generateId(), {weight:9, directed: true, stroke : "
        #000000"});
        });
        });

        var layouter = new Graph.Layout.Spring(g);

        var renderer = new Graph.Renderer.Raphael('canvas', g, width, height);

        redraw = function()
        {
        layouter.layout();
        renderer.draw();
        };
        };*/

    </script>

</body>
</html>