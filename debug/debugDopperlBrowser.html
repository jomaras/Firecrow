<!DOCTYPE html>
<html>
<head>
    <title>Firecrow - Debugging Doppel Browser</title>
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="../chrome/content/Firecrow/usageScenarioGenerator/UsageScenarioGenerator.js"></script>
    <script src="../chrome/content/Firecrow/parsers/CssSelectorParser.js"></script>
    <script src="interpreterTestsModelMapping.js"></script>
    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/UriHelper.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/slicingCriterion.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/inclusionFinder.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyPostprocessor.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeMarkupGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeHtmlGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeTextGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/commands/Command.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/FcValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayCallbackExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/XMLHttpRequest.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Math.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/FunctionFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Date.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Image.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Element.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/HTMLImageElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Canvas.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DocumentExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElementExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/CSSStyleDeclaration.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DOMProperties.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/SimpleXPath.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/EventListenerMixin.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Event.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/DependencyCreator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/webFile.js"></script>
    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/DependencyGenerator.js"></script>

    <link href="style/codeColoring.css" rel="stylesheet" type="text/css">

    <style>
        #codeContainer
        {
            float: left;
            width: 700px;
        }

        #messageContainer
        {
            float:left;
            width: 350px;
        }

        .selected { background-color: green; }
        .dependent { background-color: yellow; }
        .secondHandDependencies { background-color: #7FFF00;}
        .unexecuted { color: gray;}
        .executed { color: black;}

    </style>
</head>
<body>
    <h1>Firecrow - Debugging Doppel Browser</h1>
    <div>
        <a id="testIdContainer"></a>
    </div>

    <br/>
    <span id="resultTitle">Result:</span>
    <br>
    <div id="lineNumberContainer"></div>
    <div id="codeContainer"></div>
    <div id="messageContainer"></div>
    <div style="clear:both"/>
    <pre id="sourceTextContainer">
    </pre>

    <script>
        var Firecrow = FBL.Firecrow;
        var WebFile = Firecrow.DoppelBrowser.WebFile;
        var Browser = Firecrow.DoppelBrowser.Browser;
        var webFile = new WebFile("file:///C:/GitWebStorm/Firecrow/debug/testFiles/62/index.html");
        var model = HtmlModelMapping.getWholeFileModel(webFile.url);

        var messageContainer = document.getElementById("messageContainer");

        var dependencyGraph = new Firecrow.DependencyGraph.DependencyGraph();
        var browser = new Browser(webFile, []);
        browser.registerSlicingCriteria(model.results.map(function(result)
        {
            for(var propName in result)
            {
                return Firecrow.DependencyGraph.SlicingCriterion.createReadIdentifierCriterion(webFile.url, -1, propName)
            }
        }));

        browser.registerNodeCreatedCallback(dependencyGraph.handleNodeCreated, dependencyGraph);
        browser.registerNodeInsertedCallback(dependencyGraph.handleNodeInserted, dependencyGraph);
        browser.registerDataDependencyEstablishedCallback(dependencyGraph.handleDataDependencyEstablished, dependencyGraph);
        browser.registerControlDependencyEstablishedCallback(dependencyGraph.handleControlDependencyEstablished, dependencyGraph);
        browser.registerControlFlowConnectionCallback(dependencyGraph.handleControlFlowConnection, dependencyGraph);
        browser.registerImportantConstructReachedCallback(dependencyGraph.handleImportantConstructReached, dependencyGraph);
        browser.registerInterpreterMessageGeneratedCallback(function(message)
        {
            var newDiv = document.createElement("div");
            newDiv.textContent = message;
            messageContainer.appendChild(newDiv);
        });

        browser.asyncBuildPage(function()
        {
            var codeContainer = document.getElementById("codeContainer");
            codeContainer.innerHTML = FBL.Firecrow.CodeHtmlGenerator.generateHtmlRepresentation(model.model);

            //dependencyGraph.markGraph(model.model.htmlElement);

            createLinksBetweenHtmlAndModel(model.model, codeContainer);

            //markSliced();

            establishDependencies(dependencyGraph);

            handleCodeSelectionEvents();

            setTitle();

            setCodeLineNumbers();

            checkForErrors(model);

            document.getElementById("sourceTextContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateCode(model.model);
        });

        function markSliced()
        {
            var allNodes = dependencyGraph.nodes;

            for(var i = 0, length = allNodes.length; i < length; i++)
            {
                var node = allNodes[i];
                var nodeModel = node.model;

                if(!nodeModel.hasBeenExecuted)
                {
                    if(nodeModel.htmlNode != null)
                    {
                        nodeModel.htmlNode.classList.add("unexecuted");
                    }
                }
                else
                {
                    if(nodeModel.htmlNode != null)
                    {
                        nodeModel.htmlNode.classList.add("executed");
                    }
                }

                if(nodeModel.shouldBeIncluded)
                {
                    if(nodeModel.htmlNode != null)
                    {
                        nodeModel.htmlNode.style.fontWeight=800;
                    }
                }
            }
        }

        function establishDependencies(dependencyGraph)
        {
            var allNodes = dependencyGraph.nodes;

            for(var i = 0, length = allNodes.length; i < length; i++)
            {
                var node = allNodes[i];
                var nodeModel = node.model;

                if(nodeModel.dependencies == null) { nodeModel.dependencies = [];}

                var edges = node.dataDependencies;

                for(var j = 0, depLength = edges.length; j < depLength; j++)
                {
                    nodeModel.dependencies.push(edges[j].destinationNode.model);
                }
            }
        }

        function createLinksBetweenHtmlAndModel(model, parentHtmlElement)
        {
            FBL.Firecrow.ASTHelper.traverseAst(model, function(modelElement, propName)
            {
                if(propName == "pathAndModel" || modelElement.type == "Program") { return; }

                var nodeId = "node" + FBL.Firecrow.CodeMarkupGenerator.formatId(modelElement.nodeId);
                var htmlNode = document.getElementById(nodeId);

                if(htmlNode == null && modelElement.type == "textNode") { return; }

                if(htmlNode == null)
                {
                    alert("Node does not exist when linking model and htmlElement - id: " + modelElement.nodeId);
                }

                modelElement.htmlNode = htmlNode;
                htmlNode.model = modelElement;
            });
        }

        function handleCodeSelectionEvents()
        {
            var codeContainer = document.getElementById("codeContainer");
            var codeNodes = codeContainer.querySelectorAll(".node");

            for(var i = 0, length = codeNodes.length; i < length; i++)
            {
                codeNodes[i].onclick = function(eventArgs)
                {
                    eventArgs.cancelBubble = true;
                    deselectAllCodeElements();
                    this.classList.add("selected");

                    var dependencies = this.model.dependencies;

                    if(dependencies == null) { return; }

                    for(var j = 0, depLength = dependencies.length; j < depLength; j++)
                    {
                        var currentItem = dependencies[j];

                        var allDependencies = {};
                        getAllDependencies(currentItem, allDependencies);

                        for(var nodeId in allDependencies)
                        {
                            var dep = allDependencies[nodeId];
                            if(dep.htmlNode != null) { dep.htmlNode.classList.add("secondHandDependencies");}
                            else { alert("Dependency does not exist: " + nodeId);}
                        }

                        if(currentItem.htmlNode != null)
                        {
                            currentItem.htmlNode.classList.add("dependent");
                        }
                        else { alert("Dependency does not exist: " + currentItem.nodeId);}
                    }
                }
            }
        }

        function getAllDependencies(item, result)
        {
            if(item == null) { return result; }

            var dependencies = item.dependencies;

            for(var i = 0, length = dependencies.length; i < length; i++)
            {
                var currItem = dependencies[i];
                if(result[currItem.nodeId] != null) { continue; }

                result[currItem.nodeId] = currItem;

                getAllDependencies(currItem, result);
            }
        }

        function markAllDependencies(item)
        {
            var dependencies = item.dependencies;

            if(dependencies == null) { return; }

            if(item.htmlNode.classList.contains("secondHandDependencies")) { return; }
            if(item.htmlNode.classList.contains("dependent")) { return; }

            for(var i = 0, length = dependencies.length; i < length; i++)
            {
                var currentItem = dependencies[i];

                if(currentItem.htmlNode.classList.contains("secondHandDependencies")) { return; }
                if(currentItem.htmlNode.classList.contains("dependent")) { return; }

                markAllDependencies(currentItem);

                if(currentItem.htmlNode != null)
                {
                    currentItem.htmlNode.classList.add("secondHandDependencies");
                }
            }
        }

        function deselectAllCodeElements()
        {
            var currentlySelected = document.querySelectorAll(".selected");
            var currentlyDependent = document.querySelectorAll(".dependent");
            var currentlySecondDependent = document.querySelectorAll(".secondHandDependencies");

            for(var i = 0, length = currentlySelected.length; i < length; i++)
            {
                currentlySelected[i].classList.remove("selected");
            }

            for(var i = 0, length = currentlyDependent.length; i < length; i++)
            {
                currentlyDependent[i].classList.remove("dependent");
            }

            for(var i = 0, length = currentlySecondDependent.length; i < length; i++)
            {
                currentlySecondDependent[i].classList.remove("secondHandDependencies");
            }
        }

        function setTitle()
        {
            var testIdContainer = document.getElementById("testIdContainer");
            testIdContainer.textContent = webFile.url;
            testIdContainer.href = webFile.url;
        }

        function setCodeLineNumbers()
        {
            var resultContainer = document.getElementById("resultTitle");
            var codeContainer = document.getElementById("codeContainer");
            var lineNumberContainer = document.getElementById("lineNumberContainer");

            var noOfLines = codeContainer.offsetHeight / resultContainer.offsetHeight;
            for(var i = 1; i <= noOfLines; i++)
            {
                var newDiv = document.createElement("div");
                newDiv.textContent = i;
                lineNumberContainer.appendChild(newDiv);
            }
        }

        function checkForErrors(model)
        {
            var globalObjectProperties = browser.globalObject.properties;
            var errors = "";
            model.results.forEach(function(result)
            {
                for(var propName in result)
                {
                    var hasBeenFound = false;
                    for(var i = 0; i < globalObjectProperties.length; i++)
                    {
                        var property = globalObjectProperties[i];
                        var propertyValue = property.value;

                        if(property.name == propName)
                        {
                            hasBeenFound = true;

                            if(propertyValue == null)
                            {
                                errors += propName + " is null, and should be: " + result[propName] + "\n";
                                break;
                            }

                            if(propertyValue.value != result[propName])
                            {
                                errors += propName + " does not match: " + result[propName] + " != " + propertyValue.value + "\n";
                            }

                            break;
                        }
                    }

                    if(!hasBeenFound)
                    {
                        errors += propName + " could not be found in global object!\n";
                    }
                }
            });

            if(errors != "") { alert("Errors on validating result:\n" + errors); }
            else
            {
                var newDiv = document.createElement("div");
                newDiv.style.color = "green";
                newDiv.textContent = "Test successful";
                messageContainer.appendChild(newDiv);
            }
        }

        window.onload = function() {
           /* var width = 1300;//$('#canvas').width();
            var height = 500;//$('#canvas').height() - 100;

            var renderHtml = function(r, n)
            {
                var textLength = n.id.length*7;
                var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
                frame.attr({'fill': '#0747CF','stroke-width' : '1px'});
                return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
            };

            var renderCss = function(r, n)
            {
                var textLength = n.id.length*7;
                var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
                frame.attr({'fill': '#CF0707','stroke-width' : '1px'});
                return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
            };

            var renderJs = function(r, n)
            {
                var textLength = n.id.length*7;
                var frame = r.rect(n.point[0] - 0.5*textLength, n.point[1] - 8, textLength, 24);
                frame.attr({'fill': '#06E606','stroke-width' : '1px'});
                return r.set().push(frame, r.text(n.point[0], n.point[1] + 4, n.id));
            };

            var g = new Graph();

            g.edgeFactory.build = function(source, target)
            {
                var e = jQuery.extend(true, {}, this.template);
                e.source = source;
                e.target = target;
                //e.style.label = "w";
                return e;
            }

            dependencyGraph.nodes.forEach(function(node)
            {
                var nodeId = node.generateId();

                var render = null;

                if(node.isHtmlNode()) { render = renderHtml; }
                else if(node.isCssNode()) { render = renderCss; }
                else if(node.isJsNode()) { render = renderJs;}

                g.addNode(nodeId, { render : render, label: nodeId });
            });

            dependencyGraph.nodes.forEach(function(node)
            {
                node.structuralDependencies.forEach(function(edge)
                {
                    g.addEdge(edge.sourceNode.generateId(), edge.destinationNode.generateId(), {weight:9, directed: true, stroke : "#000000"});
                });

                node.dataDependencies.forEach(function(edge)
                {
                    g.addEdge(edge.sourceNode.generateId(), edge.destinationNode.generateId(), {weight:9, directed: true, stroke : "#FF0000"});
                });
            });

            var layouter = new Graph.Layout.Spring(g);

            var renderer = new Graph.Renderer.Raphael('canvas', g, width, height);

            redraw = function()
            {
                layouter.layout();
                renderer.draw();
            };*/
        };
    </script>

</body>
</html>