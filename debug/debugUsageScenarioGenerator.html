<!DOCTYPE html>
<html>
<head>
    <title>Usage Scenario Generator</title>
    <meta charset="UTF-8"/>
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="usageScenarioGenerator/modelMapping.js"></script>
    <script src="../chrome/content/Firecrow/parsers/CssSelectorParser.js"></script>
    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/RequestHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/UriHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/TimerHelper.js"></script>

    <script src="../chrome/content/Firecrow/scenarioGenerator/Event.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/Scenario.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/ScenarioCollection.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/ScenarioBrowserHelper.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/ScenarioGenerator.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/SeleniumCodeGenerator.js"></script>

    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/NumberRange.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/StringConstraint.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/Expression.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/PathConstraint.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/SymbolicExecutor.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/ConstraintResolver.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/slicingCriterion.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/inclusionFinder.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyPostprocessor.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeMarkupGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeTextGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/commands/Command.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/FcValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayCallbackExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/XMLHttpRequest.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Math.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/FunctionFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Date.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Image.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Element.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/HTMLImageElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Canvas.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DocumentExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElementExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/CSSStyleDeclaration.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DOMProperties.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/SimpleXPath.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/EventListenerMixin.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Event.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/DependencyCreator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>


    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/webFile.js"></script>
    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/ExecutionInfo.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/DependencyGenerator.js"></script>
    <script src="../chrome/content/Firecrow/Slicer.js"></script>
    <script src="../chrome/content/Firecrow/Reuser.js"></script>
    <script src="../chrome/content/Firecrow/templates/reuserTemplates.js"></script>

    <link href="style/codeColoring.css" rel="stylesheet" type="text/css">

    <style>
        #pageCodeContainer
        {
            width: 800px;
        }

        .reportContainer
        {
            float: left;
        }

        #executedScenarioTracesContainer,
        #keptScenarioTracesContainer
        {
            width: 400px;
        }

        iframe
        {
            margin: 0;
            border: none;
        }

        .selected { background-color: green; }
        .dependent { background-color: yellow; }
        .secondHandDependencies { background-color: #7FFF00;}
        .unexecuted { color: gray;}
        .executed { color: black;}

        .scenarioHeader { color: blue; font-weight: bold; }
        .formulaHeader { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Firecrow - Debugging Usage Scenario Generator</h1>
    <iframe id="firecrowFrame" height="300" width="300" style="overflow:scroll;"></iframe>

    <div class="reportContainer" id="pageCodeContainer"></div>
    <div class="reportContainer">
        <h2 id="executedScenariosTitle">Executed scenarios: </h2>
        <h4 id="elapsedTimeTitle"></h4>
        <div style="font-weight: bolder;">
            <div id="statementCoverageTitle"></div>
            <div id="branchCoverageTitle"></div>
        </div>
        <hr/>

        <div id="executedScenarioTracesContainer"></div>
        <br/><br/>

        <h2 id="keptScenarioTitle">Kept scenarios: </h2>
        <div id="keptScenarioTracesContainer">

        </div>
        <br/><br/>

        <h2>Selenium Code: </h2>
        <textarea style="width: 400px; min-height: 400px;" id="seleniumCodeContainer"></textarea>

    </div>

    <!--<script src="usageScenarioGenerator/fullPages/original/snake/modelMapping.js"></script>-->
    <!--<script src="usageScenarioGenerator/fullPages/original/snake/modelMapping.js"></script>-->
    <!--<script src="usageScenarioGenerator/fullPages/original/ticTacToeCase/modelMapping.js"></script>-->
    <script src="usageScenarioGenerator/fullPages/evaluationApplications/3dmodel/modelMapping.js"></script>
    <script type="text/javascript">
        //maybe i should create probability groups, and then from that group choose the one with with least events - see test 15, 16 for the problem
        //test26 - it seems that it does not log writing to html element objects as joint behavior
        //6, 18, 19 - have problems probably because of always solving to same constraints - have to add making constraints stricter
        //30 only one timeout happens - why not more?
        //var model = models[37];
        var model = models[36];
        var uiControlsSelectors = model.uiControlsSelectors;

        var pageCodeContainer = document.getElementById("pageCodeContainer");
        var executedScenarioTracesContainer = document.getElementById("executedScenarioTracesContainer");
        var keptScenarioTracesContainer = document.getElementById("keptScenarioTracesContainer");
        var executedScenarioTitle = document.getElementById("executedScenariosTitle");
        var keptScenarioTitle = document.getElementById("keptScenarioTitle");
        var elapsedTimeTitle = document.getElementById("elapsedTimeTitle");
        var statementCoverageTitle = document.getElementById("statementCoverageTitle");
        var branchCoverageTitle = document.getElementById("branchCoverageTitle");

        var scenarioInfoContainer = executedScenarioTracesContainer;

        pageCodeContainer.innerHTML = FBL.Firecrow.CodeMarkupGenerator.generateHtmlRepresentation(model.pageModel);

        var scenarioCounter = 0;

        var timer = new FBL.Firecrow.TimerHelper.createTimer();
        var lastTime = 0;

        var scGenerator = FBL.Firecrow.ScenarioGenerator;

        scGenerator.ScenarioGenerator.generateScenarios(model.pageModel, uiControlsSelectors, function(scenario, eventCoverage)
        {
            if(FBL.Firecrow.ValueTypeHelper.isArray(scenario))
            {
                var usageScenarios = scenario;
                var coverage = FBL.Firecrow.ASTHelper.calculateCoverage(model.pageModel);
                executedScenarioTitle.innerHTML += scenarioCounter + " - <b style='color:red'>" + coverage.expressionCoverage *100  + "%</b>";
                keptScenarioTitle.innerHTML += usageScenarios.length + " - <b style='color:red'>" + coverage.expressionCoverage *100 + "%</b>";
                pageCodeContainer.innerHTML = FBL.Firecrow.CodeMarkupGenerator.generateHtmlRepresentation(model.pageModel);
                statementCoverageTitle.textContent = "Statement coverage: " + coverage.statementCoverage*100 + "% ";
                branchCoverageTitle.textContent = "Branch coverage: " + coverage.branchCoverage*100 + "%";

                scenarioCounter = 0;
                scenarioInfoContainer = keptScenarioTracesContainer;

                setTimeout(function()
                {
                    usageScenarios.forEach(function(scenario)
                    {
                        generateScenarioHtml(scenario);
                    });

                    document.getElementById("seleniumCodeContainer").textContent = scGenerator.SeleniumCodeGenerator.generateCode(usageScenarios, model.pageModel.pageUrl);
                }, 1000);

                document.title += " Fin!";
            }
            else
            {
                elapsedTimeTitle.textContent = scenarioCounter
                                            + " - Time: " + timer.getElapsedTimeInSeconds()
                                            + " sec; Delta: " + (timer.getElapsedTimeInSeconds() - lastTime) + " sec"
                                            + " Coverage: " + scGenerator.ScenarioGenerator.achievedCoverage;
                lastTime = timer.getElapsedTimeInSeconds();
                document.title = scenarioCounter + "/" + scGenerator.ScenarioGenerator.scenarioProcessingLimit + " "
                               + "C:" + scGenerator.ScenarioGenerator.achievedCoverage.toString().substring(0, 4) + " "
                               + "T:" + (timer.getElapsedTimeInSeconds() - lastTime);

                generateScenarioHtml(scenario);
            }
        });

        function generateScenarioHtml(scenario)
        {
            var resolvedResult = scenario.inputConstraint.resolvedResult;
            var html = "<div class='scenarioHeader'>Scenario " + scenarioCounter + " (id: " + scenario.id + ") " + scenario.createdBy +"</div>";
            var formulaString = scenario.inputConstraint != null ? (scenario.inputConstraint + " =&gt; " + JSON.stringify(resolvedResult))
                                                                 : "undefined";

            if(scenarioInfoContainer == executedScenarioTracesContainer)
            {
                html += "<div class='scenarioAchievedCoverageContainer'>Achieved Coverage: " + scGenerator.ScenarioGenerator.achievedCoverage  + "</div>";
                html += "<div class='scenarioTime'>" + elapsedTimeTitle.textContent  + "</div>";
            }

            html += "<div class='formulaHeader'>Formula: <b>" + formulaString  + "</div>";
            html += "<ol start='0'>";

            var events = scenario.events;

            for(var i = 0; i < events.length; i++)
            {
                var event = events[i];

                html += "<li>";
                html += event.toString() + " -&gt; " + JSON.stringify(resolvedResult[i]);
                html += "</li>";
            }

            html += "</ol>";

            var wrapper = document.createElement("div");
            wrapper.className = "scenarioWrapperContainer";
            wrapper.innerHTML = html;

            scenarioInfoContainer.appendChild(wrapper);

            //localStorage.setItem('lastGeneratedScenarioInfo', html);

            scenarioCounter++;
        }
    </script>
</body>
</html>