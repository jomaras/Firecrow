<!DOCTYPE html>
<html>
<head>
    <title>Firecrow - Debug Slicing</title>
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="domModelMapping.js"></script>
    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/slicingCriterion.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/inclusionFinder.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyPostprocessor.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeMarkupGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeHtmlGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeTextGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/JsValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Math.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/CSSStyleDeclaration.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/webFile.js"></script>
    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/DependencyGenerator.js"></script>

    <link href="style/codeColoring.css" rel="stylesheet" type="text/css">

    <style>
        #codeContainer
        {
            float: left;
            width: 600px;
        }

        #slicedCodeContainer
        {
            float:left;
            width: 600px;
        }

        .selected { background-color: green; }
        .dependent { background-color: yellow; }
        .secondHandDependencies { background-color: #7FFF00;}
        .unexecuted { color: gray;}
        .executed { color: black;}

    </style>
</head>
<body>
<h1>Firecrow - Debugging DOM Slicing</h1>
<div>
    <a id="testIdContainer"></a>
</div>

<br/>
<span id="resultTitle">Result:</span>
<div id="messageContainer"></div>
<br>
<div id="lineNumberContainer"></div>
<div id="codeContainer">
    <pre id="sourceTextContainer">
    </pre>
</div>
<div id="slicedCodeContainer">
    <pre id="slicedSourceTextContainer"></pre>
</div>
<div style="clear:both"/>

    <script>
    var Firecrow = FBL.Firecrow;
    var WebFile = Firecrow.DoppelBrowser.WebFile;
    var Browser = Firecrow.DoppelBrowser.Browser;
    var webFile = new WebFile("file:///C:/GitWebStorm/Firecrow/debug/domTests/01/index.html");
    var model = HtmlModelMapping.getWholeFileModel(webFile.url);
    var messageContainer = document.getElementById("messageContainer");

    var dependencyGraph = new Firecrow.DependencyGraph.DependencyGraph();
    var browser = new Browser(webFile, []);
    browser.registerSlicingCriteria(model.results.map(function(result)
    {
        for(var propName in result)
        {
            return Firecrow.DependencyGraph.SlicingCriterion.createReadIdentifierCriterion(webFile.url, -1, propName);
        }
    }));

    browser.registerNodeCreatedCallback(dependencyGraph.handleNodeCreated, dependencyGraph);
    browser.registerNodeInsertedCallback(dependencyGraph.handleNodeInserted, dependencyGraph);
    browser.registerDataDependencyEstablishedCallback(dependencyGraph.handleDataDependencyEstablished, dependencyGraph);
    browser.registerControlDependencyEstablishedCallback(dependencyGraph.handleControlDependencyEstablished, dependencyGraph);
    browser.registerControlFlowConnectionCallback(dependencyGraph.handleControlFlowConnection, dependencyGraph);
    browser.registerImportantConstructReachedCallback(dependencyGraph.handleImportantConstructReached, dependencyGraph);
    browser.registerInterpreterMessageGeneratedCallback(function(message)
    {
        /*var messageItemContainer = document.createElement("div");
        messageItemContainer.textContent = message;
        messageContainer.appendChild(messageItemContainer);*/
    });

    browser.asyncBuildPage(function()
    {
        dependencyGraph.markGraph(model.model.htmlElement);

        setTitle();

        checkForErrors(model);

        document.getElementById("sourceTextContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateCode(model.model);
        document.getElementById("slicedSourceTextContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateSlicedCode(model.model);
    });

    function getAllDependencies(item, result)
    {
        if(item == null) { return result; }

        var dependencies = item.dependencies;

        for(var i = 0, length = dependencies.length; i < length; i++)
        {
            var currItem = dependencies[i];
            if(result[currItem.nodeId] != null) { continue; }

            result[currItem.nodeId] = currItem;

            getAllDependencies(currItem, result);
        }
    }


    function setTitle()
    {
        var testIdContainer = document.getElementById("testIdContainer");
        testIdContainer.textContent = webFile.url;
        testIdContainer.href = webFile.url;
    }

    function checkForErrors(model)
    {
        var globalObjectProperties = browser.globalObject.properties;

        var errors = "";

        var generated = FBL.Firecrow.CodeTextGenerator.generateSlicedCode(model.model);
        var fromModel = atob(model.slicingResult);

        if(generated != fromModel)
        {
           errors += "Slicing does not match!";
        }


        model.results.forEach(function(result)
        {
            for(var propName in result)
            {
                var hasBeenFound = false;
                for(var i = 0; i < globalObjectProperties.length; i++)
                {
                    var property = globalObjectProperties[i];
                    var propertyValue = property.value;

                    if(property.name == propName)
                    {
                        hasBeenFound = true;

                        if(propertyValue == null)
                        {
                            errors += propName + " is null, and should be: " + result[propName] + "\n";
                            break;
                        }

                        if(propertyValue.value != result[propName])
                        {
                            errors += propName + " does not match: " + result[propName] + " != " + propertyValue.value + "\n";
                        }

                        break;
                    }
                }

                if(!hasBeenFound)
                {
                    errors += propName + " could not be found in global object!\n";
                }
            }
        });

        if(errors != "") { alert("Errors on validating result:\n" + errors); }
        else
        {
            var newDiv = document.createElement("div");
            newDiv.style.color = "green";
            newDiv.textContent = "Test successful";
            messageContainer.appendChild(newDiv);
        }
    }
    </script>
</body>
</html>