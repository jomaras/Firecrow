<!DOCTYPE html>
<html>
<head>
    <title>Firecrow - Debug Reuse Case Study</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="../chrome/content/Firecrow/parsers/CssSelectorParser.js"></script>

    <script>
        var HtmlModelMapping = [];
    </script>

    <script src="../tests/ICSE_reuseStudies/07_05_02/pageA.html-codeModel.txt"></script>
    <script src="../tests/ICSE_reuseStudies/07_05_02/pageB.html-codeModel.txt"></script>
    <script>
        /*
        * 01 - body; 02 - #fb-root
        * 03 - #content; 04 - #sizer
        * 05 - #fb-root; 06 - #content
        * 07 - body; 08 - #fb-root
        * 09 - #content*/
        var htmlModel =
        {
            reuseAppModel: HtmlModelMapping[0].model,
            reuseIntoAppModel: HtmlModelMapping[1].model,
            reuseSelectors: HtmlModelMapping[0].model.trackedElementsSelectors,
            reuseIntoDestinationSelectors: ["body"]
        };

        /*TODO:
            - log every DOM modification (is already logged in the htmlElement.elementModificationPoints)
            - Create an esprima wrapper that gets the model of the page
            - Parse the web page code, but watch the origin
            - Execute the source code and gather the execution info, which includes events from both applications
            - Check for consistency (do the same constructs modify the nodes, when node modification is done, is it
              with the code from the matching application, etc.)
        */
    </script>

    <script src="../chrome/content/Firecrow/usageScenarioGenerator/UsageScenarioGenerator.js"></script>

    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/UriHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/TimerHelper.js"></script>

    <script src="../chrome/content/Firecrow/scenarioGenerator/Event.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/Scenario.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/ScenarioGenerator.js"></script>

    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/NumberRange.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/StringConstraint.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/Expression.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/PathConstraint.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/SymbolicExecutor.js"></script>
    <script src="../chrome/content/Firecrow/scenarioGenerator/symbolic/ConstraintResolver.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyHighlighter.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/slicingCriterion.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/inclusionFinder.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyPostprocessor.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeMarkupGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeHtmlGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeTextGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/commands/Command.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/FcValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/object/ObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/globalObject/GlobalObjectExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayCallbackExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/array/ArrayPrototype.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/XMLHttpRequest.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Math.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/FunctionFunction.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Date.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Image.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Element.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/HTMLElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/HTMLImageElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Canvas.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Error.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DocumentExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/HtmlElementExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/CSSStyleDeclaration.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/DOMProperties.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/SimpleXPath.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/EventListenerMixin.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/DOM/Event.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/DependencyCreator.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/ExecutionInfo.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/DependencyGenerator.js"></script>
    <script src="../chrome/content/Firecrow/Slicer.js"></script>

    <script src="../chrome/content/Firecrow/Reuser.js"></script>
    <script src="../chrome/content/Firecrow/reuseValidator/ReuseValidator.js"></script>
    <script src="../chrome/content/Firecrow/templates/reuserTemplates.js"></script>
    <script src="../chrome/content/Firecrow/parsers/esprima.js"></script>

    <link href="style/codeColoring.css" rel="stylesheet" type="text/css">

    <style>
        .codeContainer
        {
            float: left;
            width: 600px;
            height: 400px;
        }

        .codeContainer textarea
        {
            overflow: auto;
            width: 590px;
            height: 400px;
        }

    </style>
</head>
<body>
<iframe id="firecrowFrame" height="1" width="1"></iframe>

<h1>Firecrow - Debugging reuse</h1>
<div>Total process time: <span id="totalTimeContainer"></span> sec</div>

<div class="codeContainer">
    <strong>Full app code:</strong>
    <textarea id="fullAppCodeContainer"></textarea>
</div>
<div class="codeContainer">
    <strong>Reused code:</strong><span id="reuseTimeContainer"></span> sec
    <textarea id="reusedAppCodeContainer"></textarea>
</div>

<div style="clear:both"/>
<br/><br/>
<div class="codeContainer">
    <strong>App to extract full code:</strong>
    <textarea id="extractedFullAppCodeContainer"></textarea>
</div>
<div class="codeContainer">
    <strong>Extracted code:</strong><span id="extractionTimeContainer"></span> sec
    <textarea id="extractedSlicedAppCodeContainer"></textarea>
</div>
<br/>
<iframe id="mergedCodeIFrame"></iframe>
<script>
    var Firecrow = FBL.Firecrow;

    var extractionTimeContainer = document.getElementById("extractionTimeContainer");
    var reuseTimeContainer = document.getElementById("reuseTimeContainer");

    var slicingCriteria = [];

    var startTimer = Firecrow.TimerHelper.createTimer();

    if(htmlModel.selectors != null)
    {
        htmlModel.selectors.forEach(function(selector)
        {
            slicingCriteria.push(Firecrow.DependencyGraph.SlicingCriterion.createModifyDomCriterion(selector));
        });
    }

    var timer = Firecrow.TimerHelper.createTimer();

    var extractedAppSlicingResult = Firecrow.Slicer.slice(htmlModel.reuseAppModel, htmlModel.reuseSelectors.map(function(selector)
    {
        return Firecrow.DependencyGraph.SlicingCriterion.createModifyDomCriterion(selector);
    }));


    document.getElementById("extractedSlicedAppCodeContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateSlicedCode(htmlModel.reuseAppModel);
    extractionTimeContainer.textContent = timer.getElapsedTimeInSeconds();

    document.getElementById("extractedFullAppCodeContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateCode(htmlModel.reuseAppModel);

    var fullAppSlicingResult = Firecrow.Slicer.slice(htmlModel.reuseIntoAppModel);
    document.getElementById("fullAppCodeContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateCode(htmlModel.reuseIntoAppModel);
    timer = Firecrow.TimerHelper.createTimer();

    var mergedModel = Firecrow.Reuser.getMergedModel
    (
        htmlModel.reuseAppModel,
        htmlModel.reuseIntoAppModel,
        extractedAppSlicingResult.dependencyGraph,
        fullAppSlicingResult.dependencyGraph,
        htmlModel.reuseSelectors,
        htmlModel.reuseIntoDestinationSelectors,
        extractedAppSlicingResult.browser,
        fullAppSlicingResult.browser
    );
    var mergedCode = FBL.Firecrow.CodeTextGenerator.generateCode(mergedModel);

    document.getElementById("reusedAppCodeContainer").textContent = mergedCode;
    reuseTimeContainer.textContent = timer.getElapsedTimeInSeconds();

    document.getElementById("totalTimeContainer").textContent = startTimer.getElapsedTimeInSeconds();

    var mergedCodeIFrame = document.getElementById("mergedCodeIFrame");
    mergedCodeIFrame.contentDocument.documentElement.innerHTML = mergedCode;

    FBL.Firecrow.ReuseValidator.validate
    (
        htmlModel.reuseAppModel,
        extractedAppSlicingResult.dependencyGraph,
        htmlModel.reuseIntoAppModel,
        fullAppSlicingResult.dependencyGraph,
        mergedModel,
        Firecrow.Reuser.replacementsMap
    );
</script>
</body>
</html>