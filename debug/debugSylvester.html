<!DOCTYPE html>
<html>
<head>
    <title>Debug Sylvester</title>
    <script>
        var FBL = undefined;
    </script>
    <script src="../chrome/content/Firecrow/initFBL.js"></script>
    <script src="sylvester/mappingInfrastructure.js"></script>
    <script src="../chrome/content/Firecrow/helpers/valueTypeHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/ASTHelper.js"></script>
    <script src="../chrome/content/Firecrow/helpers/htmlHelper.js"></script>

    <script src="../chrome/content/Firecrow/dependencyGraph/node.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/edge.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyGraph.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/slicingCriterion.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/inclusionFinder.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/dependencyPostprocessor.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeMarkupGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeHtmlGenerator.js"></script>
    <script src="../chrome/content/Firecrow/codeMarkupGenerator/codeTextGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/commands/CommandGenerator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/JsValue.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Object.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/GlobalObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Array.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Math.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/RegEx.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Function.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Identifier.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/internal/Boolean.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/Number.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/internal/String.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/model/Document.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/HtmlElement.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/TextNode.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/Attribute.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/ClassList.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/model/CSSStyleDeclaration.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/simulator/VariableObject.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/InternalExecutor.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/ExecutionContextStack.js"></script>
    <script src="../chrome/content/Firecrow/interpreter/simulator/Evaluator.js"></script>

    <script src="../chrome/content/Firecrow/interpreter/InterpreterSimulator.js"></script>

    <script src="../chrome/content/Firecrow/doppelBrowser/webFile.js"></script>
    <script src="../chrome/content/Firecrow/doppelBrowser/browser.js"></script>
    <script src="../chrome/content/Firecrow/dependencyGraph/DependencyGenerator.js"></script>
</head>
<body>
    <script src="sylvester/11-LineSegment-distanceFrom/htmlMapping.js"></script>
    <pre id="sourceTextContainer">
    </pre>

    <script>
        var Firecrow = FBL.Firecrow;
        var WebFile = Firecrow.DoppelBrowser.WebFile;
        var Browser = Firecrow.DoppelBrowser.Browser;
        var webFile = new WebFile("file:///C:/GitWebStorm/Firecrow/debug/sylvester/11-LineSegment-distanceFrom/index.html");

        var model = HtmlModelMapping.getWholeFileModel(webFile.url);
        //var messageContainer = document.getElementById("messageContainer");

        var dependencyGraph = new Firecrow.DependencyGraph.DependencyGraph();
        var browser = new Browser(webFile, []);
        browser.registerSlicingCriteria(model.results.map(function(result)
        {
            for(var propName in result)
            {
                return Firecrow.DependencyGraph.SlicingCriterion.createReadIdentifierCriterion(webFile.url, -1, propName);
            }
        }));

        browser.registerNodeCreatedCallback(dependencyGraph.handleNodeCreated, dependencyGraph);
        browser.registerNodeInsertedCallback(dependencyGraph.handleNodeInserted, dependencyGraph);
        browser.registerDataDependencyEstablishedCallback(dependencyGraph.handleDataDependencyEstablished, dependencyGraph);
        browser.registerControlDependencyEstablishedCallback(dependencyGraph.handleControlDependencyEstablished, dependencyGraph);
        browser.registerControlFlowConnectionCallback(dependencyGraph.handleControlFlowConnection, dependencyGraph);
        browser.registerImportantConstructReachedCallback(dependencyGraph.handleImportantConstructReached, dependencyGraph);
        browser.registerInterpreterMessageGeneratedCallback(function(message)
        {
        });

        browser.asyncBuildPage(function()
        {
            dependencyGraph.markGraph(model.model.htmlElement);

            document.getElementById("sourceTextContainer").textContent = FBL.Firecrow.CodeTextGenerator.generateSlicedCode(model.model);

            var globalObjectProperties = browser.globalObject.properties;
            var errors = "";
            model.results.forEach(function(result)
            {
                for(var propName in result)
                {
                    var hasBeenFound = false;
                    for(var i = 0; i < globalObjectProperties.length; i++)
                    {
                        var property = globalObjectProperties[i];
                        var propertyValue = property.value;

                        if(property.name == propName)
                        {
                            hasBeenFound = true;

                            if(propertyValue == null)
                            {
                                errors += propName + " is null, and should be: " + result[propName] + "\n";
                                break;
                            }

                            if(propertyValue.value != result[propName])
                            {
                                errors += propName + " does not match: " + result[propName] + " != " + propertyValue.value + "\n";
                            }

                            break;
                        }
                    }

                    if(!hasBeenFound)
                    {
                        errors += propName + " could not be found in global object!\n";
                    }
                }
            });

            if(errors != "") { alert("Errors on validating result:\n" + errors); }
            else
            {
                //var newDiv = document.createElement("div");
                //newDiv.style.color = "green";
                //newDiv.textContent = "Test successful";
                //messageContainer.appendChild(newDiv);
            }
        });
    </script>

</body>
</html>